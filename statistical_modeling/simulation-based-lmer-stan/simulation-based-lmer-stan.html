<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yingqi Jing">
<meta name="dcterms.date" content="2025-07-22">

<title>Simulation-based Linear Mixed-effects Models with Stan – Data Science Toolkit</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../css/webstyles.css">
<link rel="stylesheet" href="../../css/blogstyles.css">
<link rel="stylesheet" href="../../css/shadenote.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Data Science Toolkit</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../statistical_modeling/coverpage.html"> 
<span class="menu-text">Statistical Modeling</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../programming/coverpage.html"> 
<span class="menu-text">Programming</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../commandline/coverpage.html"> 
<span class="menu-text">Command Line</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://jakejing.github.io/datasciencetoolkit/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Simulation-based Linear Mixed-effects Models with Stan</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#matrix-form-of-the-mixed-effect-regression-model" id="toc-matrix-form-of-the-mixed-effect-regression-model" class="nav-link active" data-scroll-target="#matrix-form-of-the-mixed-effect-regression-model"><span class="header-section-number">1</span> Matrix form of the mixed effect regression model</a></li>
  <li><a href="#r-script-for-simulating-the-data" id="toc-r-script-for-simulating-the-data" class="nav-link" data-scroll-target="#r-script-for-simulating-the-data"><span class="header-section-number">2</span> R script for simulating the data</a></li>
  <li><a href="#fit-the-linear-mixed-effect-regression-model-with-stan" id="toc-fit-the-linear-mixed-effect-regression-model-with-stan" class="nav-link" data-scroll-target="#fit-the-linear-mixed-effect-regression-model-with-stan"><span class="header-section-number">3</span> Fit the linear mixed effect regression model with stan</a>
  <ul>
  <li><a href="#form" id="toc-form" class="nav-link" data-scroll-target="#form"><span class="header-section-number">3.1</span> Form</a></li>
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model"><span class="header-section-number">3.2</span> Model</a></li>
  <li><a href="#run-the-analysis" id="toc-run-the-analysis" class="nav-link" data-scroll-target="#run-the-analysis"><span class="header-section-number">3.3</span> Run the analysis</a></li>
  <li><a href="#traceplot" id="toc-traceplot" class="nav-link" data-scroll-target="#traceplot"><span class="header-section-number">3.4</span> Traceplot</a></li>
  </ul></li>
  <li><a href="#useful-references-and-links" id="toc-useful-references-and-links" class="nav-link" data-scroll-target="#useful-references-and-links"><span class="header-section-number">4</span> Useful references and links</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="simulation-based-lmer-stan.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Simulation-based Linear Mixed-effects Models with Stan</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Yingqi Jing </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 22, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>In this blog, I will provide a step-by-step instruction of how we can generate data from a mixed effect model and recover the parameters of the model with the simulated dataset. This simulation-based experiment can help us better understand the structure and generative process of the multilevel model with correlated random intercepts and slopes. To proceed, I will first illustrate the general form of mixed effect models, and generate data based on a given set of design matrices and parameters (<span class="math inline">\(X,\beta, Z, b\)</span>). In the end, I will set a Bayesian model to estimate the parameters on the simulated data via <code>stan</code>.</p>
<section id="matrix-form-of-the-mixed-effect-regression-model" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Matrix form of the mixed effect regression model</h1>
<p>The general form of a mixed effect model can be illustrated in the following way:</p>
<p><span class="math display">\[
y \sim X \beta + Z b + \epsilon
\]</span></p>
<p>where <span class="math inline">\(y\)</span> is a vector of dependent variables, and the two design matrices, <span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span>, are related to fixed effects and random effects, respectively. The parameters of fixed effects are captured by <span class="math inline">\(\beta\)</span>, and the random effects (e.g., random intercepts and slopes) are specified in <span class="math inline">\(b\)</span>, which is generated from a Multivariate Normal (MN) distribution with mean <span class="math inline">\(0\)</span> and variance-covariance matrix <span class="math inline">\(\Sigma\)</span>. The random errors are indicated by <span class="math inline">\(\epsilon\)</span>.</p>
<p>To be more specific, I will expand the matrix form and provide a detailed description of the process for generating the fixed effects, random effects and response. As an example, I will assume a continuous predictor <span class="math inline">\(x\)</span> and correlated random intercepts and slopes. This can also be expressed by the <code>lmer</code> style syntax as: <span class="math display">\[
y \sim 1 + x + (x | group)
\]</span></p>
<ul>
<li>Step 1: generate fixed effects (<span class="math inline">\(X\beta\)</span>)</li>
</ul>
<p><span class="math display">\[
X \beta = \begin{bmatrix}
1  &amp; 1 \\
1  &amp; 2 \\[0.4em]
\cdots   &amp; \cdots \\[0.4em]
\cdots   &amp; \cdots \\[0.4em]
1  &amp;  9 \\
1  &amp; 10 \\[0.8em]
\cdots   &amp; \cdots \\[1em]
1  &amp; 1 \\
1  &amp; 2 \\[0.2em]
\cdots   &amp; \cdots \\[0.6em]
\cdots   &amp; \cdots \\[0.6em]
1  &amp;  9 \\
1  &amp; 10 \\[0.2em]
\end{bmatrix}\times
\begin{bmatrix}
  6 \\
  4
\end{bmatrix} =
\begin{bmatrix}
10   \\
14   \\[0.6em]
\cdots  \\[0.6em]
\cdots  \\[0.6em]
42   \\
46  \\[0.6em]
\cdots  \\[0.6em]
10   \\
14   \\[0.6em]
\cdots  \\[0.6em]
\cdots  \\[0.6em]
42  \\
46  
\end{bmatrix}
\]</span></p>
<p>The design matrix <span class="math inline">\(X\)</span> consists of two columns, where the first column of 1 is a dummy column related to the intercept and the second column is the predictor <span class="math inline">\(x\)</span> ranging from 1 to 10 for each group. The parameters of <span class="math inline">\(\beta\)</span> represent the intercept and slope at the population level.</p>
<ul>
<li><p>Step 2: generate random effects (<span class="math inline">\(Zb\)</span>)</p>
<p>Before simulating the correlated random intercepts and slopes, we first need to prepare the variance-covariance matrix <span class="math inline">\(\Sigma\)</span>, which is created by multiplying a diagonal matrix, correlation matrix (<span class="math inline">\(R\)</span>) and a diagonal matrix.</p></li>
</ul>
<p><span class="math display">\[
\begin{split}
b &amp;\sim \mathcal{N}(0, \Sigma) \\
\Sigma &amp;= \left(\begin{array}{c}\sigma_{\alpha}^2 ~~~ \rho\sigma_\alpha\sigma_{\beta}\\ \rho\sigma_\alpha\sigma_{\beta} ~~~ \sigma_\beta^2\end{array}\right)\\
&amp;= \left(\begin{array}{c}\sigma_\alpha ~~ 0\\ 0 ~~ \sigma_\beta\end{array}\right) \underbrace{\left(\begin{array}{c}1 ~~~ \rho \\ \rho ~~~ 1 \end{array}\right)}_{R}  \left(\begin{array}{c}\sigma_\alpha ~~ 0\\ 0 ~~ \sigma_\beta
\end{array}\right)
\end{split}
\]</span></p>
<p>With the variance-covariance matrix, we can generate the parameters <span class="math inline">\(b\)</span> for random intercepts and slopes. The resulting matrix <span class="math inline">\(b\)</span> includes two columns, corresponds to random intercepts and slopes, respectively. Each row of the matrix b indicates the group-specific random effects.</p>
<p>To generate the outcome of random effects, we need to make the design matrix <span class="math inline">\(Z\)</span> and random effect parameter <span class="math inline">\(b\)</span> in the following format. Of course, you do not need to stick with this interleaved format of random intercepts. There are also some other ways for generating the random outcomes (see section 2 in the R script). <span class="math display">\[
Z b = \begin{bmatrix}
1  &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
1  &amp; 2 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
1  &amp; 3 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
1  &amp; 4 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
1  &amp; 5 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
1  &amp; 6 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
1  &amp; 7 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
1  &amp; 8 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
1  &amp; 9 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
1  &amp; 10 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 1 &amp; 1 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 1 &amp; 2 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 1 &amp; 3 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 1 &amp; 4 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 1 &amp; 5 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 1 &amp; 6 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 1 &amp; 7 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 1 &amp; 8 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 1 &amp; 9 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 1 &amp; 10 &amp; 0 &amp; 0\\
0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 1 \\
0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 2\\
0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 3 \\
0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 4 \\
0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 5 \\
0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 6 \\
0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 7 \\
0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 8 \\
0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 9 \\
0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 10 \\
\end{bmatrix}\times
\begin{bmatrix}
  Intercept_{g_1} \\
  Slope_{g_1} \\
  Intercept_{g_2} \\
  Slope_{g_2} \\
  Intercept_{g_3} \\
  Slope_{g_3} \\
\end{bmatrix} =
\begin{bmatrix}
~ 2.9   \\
~ 4.8   \\
~ 6.8   \\
~ 8.7   \\
~ 10.6   \\
~ 12.5   \\
~ 14.4   \\
~ 16.4   \\
~ 18.3   \\
~ 20.2   \\
-6.3   \\
-8.4   \\
-10.5   \\
-12.6   \\
-14.7   \\
-16.8   \\
-18.9   \\
-21   \\
-23   \\
-25   \\
~~ 1.7   \\
~~ 2.8   \\
~~~ 4   \\
~ 5.1   \\
~ 6.2   \\
~ 7.3   \\
~ 8.5   \\
~ 9.6   \\
~ 10.7   \\
~ 11.8   \\
\end{bmatrix}
\]</span></p>
<ul>
<li><p>Step 3: generate response by combining fixed, random outcomes and errors</p>
<p>Now we can generate the response <span class="math inline">\(y\)</span> by combining fixed, random outcomes and errors <span class="math inline">\(\epsilon \sim \mathcal{N}(0, 1)\)</span>. This response will serve as the observations in the Bayesian hierarchical model. <span class="math display">\[
y = X\beta + Zb =
\begin{bmatrix}
10   \\
14   \\
18   \\
22   \\
26   \\
30   \\
34   \\
38   \\
42   \\
46   \\
10 \\
14 \\
18 \\
22 \\
26 \\
30 \\
34 \\
38 \\
42 \\
46 \\
10   \\
14   \\
18   \\
22   \\
26   \\
30   \\
34   \\
38   \\
42   \\
46   \\
\end{bmatrix}
+ \begin{bmatrix}
~ 2.9   \\
~ 4.8   \\
~ 6.8   \\
~ 8.7   \\
~ 10.6   \\
~ 12.5   \\
~ 14.4   \\
~ 16.4   \\
~ 18.3   \\
~ 20.2   \\
-6.3   \\
-8.4   \\
-10.5   \\
-12.6   \\
-14.7   \\
-16.8   \\
-18.9   \\
-21   \\
-23   \\
-25   \\
~~ 1.7   \\
~~ 2.8   \\
~~~ 4   \\
~ 5.1   \\
~ 6.2   \\
~ 7.3   \\
~ 8.5   \\
~ 9.6   \\
~ 10.7   \\
~ 11.8   \\
\end{bmatrix} +
\epsilon
\]</span></p></li>
</ul>
</section>
<section id="r-script-for-simulating-the-data" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> R script for simulating the data</h1>
<p>To make it easier, I also include the R scripts for you to generate the data based on the matrix format described above. Each block of scripts is corresponding to the previous steps for creating fixed, random and response outcomes.</p>
<ul>
<li>Step 1: generate fixed effects (<span class="math inline">\(X\beta\)</span>)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>N_group <span class="ot">=</span> <span class="dv">3</span> <span class="co"># number of groups</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>N_elements_group <span class="ot">=</span> <span class="dv">10</span> <span class="co"># number of elements in each group</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">intercept =</span> <span class="dv">1</span>, </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span>N_elements_group,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">group_id=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N_group, <span class="at">each =</span> N_elements_group),</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="dv">0</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">as.matrix</span>(df[, <span class="fu">c</span>(<span class="st">"intercept"</span>, <span class="st">"x"</span>)]) <span class="co"># design matrix X</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>fixed_outcome <span class="ot">=</span> X <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">4</span>) <span class="co"># X*beta</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fixed_outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]
[1,]   10
[2,]   14
[3,]   18
[4,]   22
[5,]   26
[6,]   30</code></pre>
</div>
</div>
<ul>
<li><p>Step 2: generate random effects (<span class="math inline">\(Zb\)</span>)</p>
<p>It is worth noting here that the two design matrices, <span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span>, are the same in our case, and we can thus generate the random outcome by using elementwise multiplication of <span class="math inline">\(X\)</span> and a reformated <span class="math inline">\(b\)</span>.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">=</span> <span class="fl">0.7</span> <span class="co"># correlation coefficient</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, rho, rho, <span class="dv">1</span>), <span class="at">ncol =</span> <span class="dv">2</span>) <span class="co"># R</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>sig1 <span class="ot">=</span> <span class="dv">3</span> <span class="co"># sd of random intercepts</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>sig2 <span class="ot">=</span> <span class="dv">2</span>  <span class="co"># sd of random slopes</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>diag_mat_tau <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(sig1, <span class="dv">0</span>, <span class="dv">0</span>, sig2), <span class="at">ncol =</span> <span class="dv">2</span>) <span class="co"># diagonal matrix</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>Sigma <span class="ot">=</span> diag_mat_tau <span class="sc">%*%</span> R <span class="sc">%*%</span> diag_mat_tau <span class="co"># VCV</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>random_eff <span class="ot">=</span> <span class="fu">mvrnorm</span>(N_group, <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), Sigma)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(random_eff)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>b <span class="ot">=</span> random_eff[<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(random_eff)), <span class="at">each =</span> N_elements_group), ]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: X and Z are the same in our case, and we use elementwise matrix multiplication</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>random_outcome <span class="ot">=</span> <span class="fu">rowSums</span>(X <span class="sc">*</span> b)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(random_outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2]
[1,] -1.612002 -1.8267120
[2,] -0.163515 -0.2731448
[3,]  0.787682 -0.9432816
[1]  -3.438714  -5.265426  -7.092138  -8.918850 -10.745562 -12.572274</code></pre>
</div>
</div>
<ul>
<li>Step 3: generate response by combining fixed, random outcomes and errors</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df_final <span class="ot">=</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fixed_outcome =</span> fixed_outcome,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">random_outcome =</span> random_outcome,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> fixed_outcome <span class="sc">+</span> random_outcome <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(df), <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_final)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  intercept x group_id         y fixed_outcome random_outcome
1         1 1        1  7.277546            10      -3.438714
2         1 2        1  8.259655            14      -5.265426
3         1 3        1 12.803637            18      -7.092138
4         1 4        1 13.751732            22      -8.918850
5         1 5        1 13.786661            26     -10.745562
6         1 6        1 17.374135            30     -12.572274</code></pre>
</div>
</div>
</section>
<section id="fit-the-linear-mixed-effect-regression-model-with-stan" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Fit the linear mixed effect regression model with stan</h1>
<p>With the simulated dataset, we can try to recover the parameters of the hierarchical model with correlated random intercepts and slopes. Here I am using <code>stan</code> to build the model and run the analysis via NUTS sampler. The structure of the model can be summarised below. Note that I didn’t decompose the correlation matrix (<span class="math inline">\(R\)</span>) via Cholesky factorization (see this blog about <a href="https://yingqijing.medium.com/multivariate-normal-distribution-and-cholesky-decomposition-in-stan-d9244b9aa623">Multivariate Normal distribution and Cholesky decomposition</a>). Instead, I am using a LKJ correlation prior for <span class="math inline">\(R\)</span>.</p>
<section id="form" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="form"><span class="header-section-number">3.1</span> Form</h2>
<p><span class="math display">\[
\begin{split}
y &amp;\sim \mathcal{N}(\mu_n, \sigma^2) \\
\mu_n &amp;= \underbrace{\alpha_0 + \beta_0 x_n}_{fixed~~effects} +\underbrace{\alpha_{j[n]} + \beta_{k[n]}x_n}_{random~~effects} \\
\left(\begin{array}{c}\alpha_{j}\\ \beta_{k}\end{array}\right) &amp;\sim  \mathcal{N}\left(\begin{array}{c}\left(\begin{array}{c}0\\ 0\end{array}\right)\end{array},\Sigma\right) \\
\Sigma &amp;= \left(\begin{array}{c}\sigma_{\alpha}^2 ~~~ \rho\sigma_\alpha\sigma_{\beta}\\ \rho\sigma_\alpha\sigma_{\beta} ~~~ \sigma_\beta^2\end{array}\right) \\
&amp;= \left(\begin{array}{c}\sigma_\alpha ~~ 0\\ 0 ~~ \sigma_\beta\end{array}\right) \underbrace{\left(\begin{array}{c}1 ~~~ \rho \\ \rho ~~~ 1 \end{array}\right)}_{R}  \left(\begin{array}{c}\sigma_\alpha ~~ 0\\ 0 ~~ \sigma_\beta
\end{array}\right)\\
R &amp;\sim \mathcal{LKJcorr}(2.0) \\
\alpha_0 &amp; \sim \mathcal{N}(0, 10) \\
\beta_0 &amp; \sim \mathcal{N}(0, 10) \\
\alpha_j &amp; \sim \mathcal{N}(0, 10) \\
\beta_k &amp; \sim \mathcal{N}(0, 10) \\
\sigma &amp; \sim \mathcal{N}(0, 5) \\
\sigma_\alpha &amp; \sim \mathcal{N}(0, 5) \\
\sigma_\beta &amp; \sim \mathcal{N}(0, 5) \\
\end{split}
\]</span></p>
</section>
<section id="model" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="model"><span class="header-section-number">3.2</span> Model</h2>
<p><script src="https://gist.github.com/JakeJing/d2b18b0b4267c6baa4a6d2bac5b72371.js"></script></p>
</section>
<section id="run-the-analysis" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="run-the-analysis"><span class="header-section-number">3.3</span> Run the analysis</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ls_final <span class="ot">=</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(df_final), </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">x =</span> <span class="fu">as.vector</span>(df_final<span class="sc">$</span>x), </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> <span class="fu">as.vector</span>(df_final<span class="sc">$</span>y),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">N_group =</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_final<span class="sc">$</span>group_id)), </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">group_id =</span> df_final<span class="sc">$</span>group_id)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>lmer_md <span class="ot">=</span> <span class="fu">stan_model</span>(<span class="at">file =</span> <span class="st">"./stan_model/lmer_prior_R.stan"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>fit_lmer_stan <span class="ot">=</span> <span class="fu">sampling</span>(lmer_md, <span class="at">data =</span> ls_final,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">chains =</span> <span class="dv">2</span>, <span class="at">iter =</span> <span class="dv">3000</span>, <span class="at">cores =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="traceplot" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="traceplot"><span class="header-section-number">3.4</span> Traceplot</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(fit_lmer_stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha_0"</span>, <span class="st">"beta_0"</span>, <span class="st">"random_group"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/traceplot.png" class="img-fluid figure-img"></p>
<figcaption>traceplot of posterior parameter estimates</figcaption>
</figure>
</div>
</section>
</section>
<section id="useful-references-and-links" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Useful references and links</h1>
<ul>
<li><p>Nicenboim, Schad and Vasishth (2021) An Introduction to Bayesian Data Analysis for Cognitive Science. <a href="https://vasishth.github.io/bayescogsci/book/">Chapter 5 Online</a>.</p></li>
<li><p>Sorensen, Tanner &amp; Shravan Vasishth (2015) Bayesian Linear Mixed Models Using Stan: A Tutorial for Psychologists, Linguists, and Cognitive Scientists. arXiv Preprint arXiv:1506.06201.</p></li>
<li><p>https://stats.stackexchange.com/questions/488188/what-are-the-steps-to-simulate-data-for-a-linear-model-with-random-slopes-and-ra</p></li>
<li><p>https://yingqijing.medium.com/lkj-correlation-distribution-in-stan-29927b69e9be</p></li>
<li><p>https://yingqijing.medium.com/multivariate-normal-distribution-and-cholesky-decomposition-in-stan-d9244b9aa623</p></li>
<li><p>https://mlisi.xyz/post/bayesian-multilevel-models-r-stan/#fn1</p></li>
</ul>



</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/JakeJing\.github\.io\/datasciencetoolkit\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>